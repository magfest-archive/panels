{% import 'macros.html' as macros %}

{% macro form_datetime(model, field_name) %}
  {%- set is_class = model is class -%}
  {%- set html_id = model.__name__|lower if is_class else model.__class__.__name__|lower ~ '_' ~ model.id -%}
  {%- set value = c.EPOCH if is_class else [c.EPOCH, [c.ESCHATON, model[field_name].astimezone(c.EVENT_TIMEZONE)]|sort|first]|sort|last -%}
  <div id="{{ html_id }}" class="input-group">
    <input
        name="{{ field_name }}"
        type="text"
        class="form-control"
        value="{{ value.strftime('%-m/%-d/%Y %-I:%M %p') }}">
    <span class="input-group-addon">
      <span class="glyphicon glyphicon-calendar"></span>
    </span>
  </div>
  <script>
    $('#{{ html_id }} input[name="{{ field_name }}"]').datetimepicker({
      sideBySide: true,
      useCurrent: false,
      defaultDate: '{{ value.isoformat() }}',
      minDate: '{{ c.EPOCH.isoformat() }}',
      maxDate: '{{ c.ESCHATON.isoformat() }}',
      format: 'M/D/Y h:mm A'
    });
  </script>
{% endmacro %}

{% macro form_duration(model, field_name) %}
  {%- set is_class = model is class -%}
  {%- set html_id = model.__name__|lower if is_class else model.__class__.__name__|lower ~ '_' ~ model.id -%}
  <div id="{{ html_id }}" class="row">
    <input name="{{ field_name }}" type="hidden" value="{{ 900 if is_class else model[field_name] }}">
    <div class="col-xs-6" style="padding-right: 10px;">
      <div class="input-group">
        <input
            type="number"
            min="0"
            value="{{ 0 if is_class else timedelta_component(seconds=model[field_name], units='hours') }}"
            class="form-control {{ field_name ~ '_hours' }}">
        <span class="input-group-addon">hours</span>
      </div>
    </div>
    <div class="col-xs-6" style="padding-left: 5px;">
      <div class="input-group">
        <input
            type="number"
            min="0"
            value="{{ 15 if is_class else timedelta_component(seconds=model[field_name], units='minutes') }}"
            class="form-control {{ field_name ~ '_minutes' }}">
        <span class="input-group-addon">minutes</span>
      </div>
    </div>
  </div>
  <script>
    $('#{{ html_id }} input[type="number"]').on('keyup blur change', function() {
      try {
        var hours = parseInt($('#{{ html_id }} input.{{ field_name ~ "_hours" }}').val().trim() || 0);
        var minutes = parseInt($('#{{ html_id }} input.{{ field_name ~ "_minutes" }}').val().trim() || 0);
        if ($.isNumeric(hours) && $.isNumeric(minutes)) {
          var seconds = (Math.max(hours, 0) * 3600) + (Math.max(minutes, 0) * 60);
          $('#{{ html_id }} input[name="{{ field_name }}"]').val(seconds);
        }
      } catch(ex) {}
    });
  </script>
{% endmacro %}

{% macro attraction_form(attraction) %}
  {%- set is_class = attraction is class -%}
  {{ csrf_token() }}
  <input type="hidden" name="id" value="{{ 'None' if attraction is class else attraction.id }}">
  {{ macros.form_group(attraction, 'name', is_focused=True, is_required=True) }}
  {{ macros.form_group(
      attraction,
      'description',
      type='textarea',
      is_required=True,
      help="This description will be displayed to attendees when they're signing up.") }}
  {% if admin_account.attendee.assigned_depts %}
    <div class="form-group">
      <label class="col-sm-3 control-label">Belongs to Department</label>
      <div class="col-sm-6">
        <select name="department_id" class="form-control">
          <option value="">This attraction doesn't belong to any department</option>
          {{ options(admin_account.attendee.assigned_depts_opts, attraction.department_id) }}
        </select>
      </div>
      <div class="col-sm-offset-3 col-sm-9 help-block">
        If the attraction belongs to a department, then department heads can
        also edit it.
      </div>
    </div>
  {% endif %}
  <div class="form-group">
    <label class="col-sm-3 control-label">Attendance Restriction</label>
    <div class="col-sm-6">
      <select name="restriction" class="form-control">
        {%- set restriction = 0 if is_class else attraction.restriction -%}
        {{ options(attraction.RESTRICTION_OPTS, restriction) }}
      </select>
    </div>
  </div>
  <div class="form-group">
    <label class="col-sm-3 control-label">Required Checkin</label>
    <div class="col-sm-6">
      <select name="required_checkin" class="form-control">
        {%- set required_checkin = 0 if is_class else attraction.required_checkin -%}
        {{ options(attraction.REQUIRED_CHECKIN_OPTS, required_checkin) }}
      </select>
    </div>
  </div>
  <div class="form-group">
    <label class="col-sm-3 control-label">Notifications</label>
    <div class="col-sm-9">
      <div class="form-control-static notifications">
        <div>
          Attendees who have <b>not</b> checked in for an event will be notified:
        </div>
        <div class="form-inline notification">
          <select name="notifications" class="form-control" style="width: auto; display: inline-block;">
            {{ options(attraction.NOTIFICATIONS_OPTS, attraction.notifications) }}
          </select>
          <span class="glyphicon glyphicon-plus-sign"></span>
        </div>
      </div>
    </div>
  </div>

  <style>
    .notification {
      margin-top: 8px;
    }

    .notifications .glyphicon-plus-sign,
    .notifications .glyphicon-minus-sign {
      font-size: 28px;
      vertical-align: middle;
    }

    .notifications .glyphicon-plus-sign:hover,
    .notifications .glyphicon-minus-sign:hover {
      opacity: 0.8;
      cursor: pointer;
    }

    .notifications .glyphicon-plus-sign { color: #60b060; }
    .notifications .glyphicon-minus-sign { color: #e06060; }
  </style>

  <script>
    $(function() {
      var $notifications = $('.notifications'),
          $notification = $notifications.children('.notification'),
          $select = $notification.children('select'),
          $button = $('.notifications .glyphicon-plus-sign'),
          template = $notification[0].outerHTML;

      var insertNotification = function(value) {
        $newNotification = $(template);
        $newNotification.insertBefore($notification);
        $newNotification.find('.glyphicon-plus-sign')
          .removeClass('glyphicon-plus-sign').addClass('glyphicon-minus-sign');
        $newSelect = $newNotification.children('select');
        $newSelect.val(value);
      };

      $notifications.on('click', '.glyphicon-minus-sign', function(event) {
        event.preventDefault();
        var $notification = $(this).closest('.notification');
        $notification.remove();
      });

      $button.on('click', function(event) {
        event.preventDefault();
        currentVal = $select.val();
        insertNotification(currentVal);
        $select.val($select.children('option[value="' + currentVal + '"]').next().prop('value'));
      });

      var ns = {{ '[900]' if attraction is class else attraction.notifications }},
          nsLength = ns.length;

      if(nsLength > 0) {
        for(var i = 0; i < nsLength - 1; i++) {
          insertNotification(ns[i]);
        }
        $select.val(ns[nsLength - 1]);
      }
    });
  </script>
{% endmacro %}
