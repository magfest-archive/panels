{% extends "base.html" %}{% set admin_area=True %}
{% block title %}{{ attraction.name }}{% endblock %}

{% import 'attractions_admin/attraction_macros.html' as attraction_macros with context %}

{% block content %}

<style>
  h1 .btn, h2 .btn, h3 .btn, h4 .btn {
    vertical-align: 33%;
  }

  h1 > span, h2 > span, h3 > span, h4 > span {
    display: inline-block;
    margin-bottom: 10px;
  }

  .btn.pull-right {
    margin-bottom: 15px;
  }

  .attraction-info {
    padding: 5px 0 5px 10px;
    margin-bottom: 10px;
  }

  .attraction-info *:last-child {
    margin-bottom: 0;
  }

  .glyphicon {
    vertical-align: text-top;
  }

  .glyphicon-ban-circle {
    color: #f4128b;
  }

  .table > tbody > tr > td {
    border-top: 0 transparent none;
    padding: 4px 10px;
  }

  .feature-help-block {
    margin-bottom: 30px;
  }

  .feature-container {

  }

  .feature-container .nav-pills h3 {
    font-size: 1em;
    margin: 0;
    overflow: hidden;
    padding: 5px 0;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .features {
  }

  .features hr {
    border-top: 1px solid #ddd;
  }

  .feature-description {
    margin: 10px 0 20px 0;
  }

  .feature {

  }

  .feature-title {
    margin-top: 0;
  }

  .feature-body {

  }

  .event-container {
    border-top: 1px solid #e0e0e0;
    border-right: 1px solid #e0e0e0;
    border-bottom: 1px solid #e0e0e0;
    border-radius: 0 3px 3px 0;
  }

  .controls {
    text-align: right;
    white-space: nowrap;
  }

  .controls form,
  .controls .btn {
    display: inline-block;
    float: none;
  }

  .room-col {
    width: 100%;
    margin-bottom: 20px;
  }

  .room-col:last-child {

  }

  .room-body {
    background-color: #f0f0f0;
    border-radius: 0 0 3px 3px;
    padding: 10px;
  }

  .room-title {
    background-color: #428bca;
    border-radius: 3px 3px 0 0;
    color: #fff;
    padding: 5px;
  }

  .room-title select {
    border: 1px solid #428bca;
  }

  .room-title label {
    font-size: 1.5em;
  }

  .room-title h5 {
    font-size: 1.25em;
    margin: 5px 0;
  }

  .event {
    background-color: #fff;
    border-radius: 3px;
    margin: 6px 0 0 0;
    padding: 5px 5px 5px 9px;
  }

  .event:first-child {
    margin-top: 0;
  }

  .event:hover {
    -webkit-box-shadow: inset 0 0 0 1px #428bca;
    box-shadow: inset 0 0 0 1px #428bca;
  }

  .event-spacer {
    margin: 0 4px -6px 4px;
    padding: 5px 0;
  }

  .event-overlap {
    font-weight: bold;
    background-color: #fff8f8;
  }

  .empty-message {
    padding-bottom: 15px;
  }

  .btn-fade {
    background-color: transparent;
    background-image: none;
    border-color: transparent;
    color: #333;
    -webkit-box-shadow: none;
    box-shadow: none;
    transition: all .2s ease-in-out;
  }

  .btn-fade:hover {
    color: #fff;
  }

  .btn-fade.btn-primary:hover {
    background-color: #2d6ca2;
    border-color: #2b669a;
  }

  .btn-fade.btn-danger:hover {
    background-color: #d9534f;
    border-color: #b92c28;
  }

  .info-block {
    border-left: 4px solid #428bca;
    border-radius: 4px;
  }

  .row-stacked {
    position: relative;
  }

  .col-sm-stacked {
    width: 100%;
    padding-right: 15px;
    padding-left: 15px;
  }

  .col-sm-stacked-content {
    position: initial;
    width: 100%;
    padding-right: 15px;
    padding-left: 15px;
  }

  .nav-sm-stacked {
    white-space: nowrap;
    overflow: auto;
    padding-bottom: 15px;
  }

  .nav-sm-stacked > li {
    max-width: 250px;
    display: inline-block;
    float: none;
  }

  @media(min-width: 768px) {
    .col-sm-stacked {
      width: 280px;
    }

    .col-sm-stacked-content {
      position: absolute;
      left: 280px;
      right: 0;
      top: 0;
      bottom: 0;
      padding-left: 0;
      width: initial;
    }

    .nav-sm-stacked {
      white-space: normal;
    }

    .nav-sm-stacked > li {
      display: block;
      float: none;
    }

    .nav-sm-stacked > li + li {
      margin-top: 2px;
      margin-left: 0;
    }
  }
</style>

<script>
  $(function() {
    var features = {{ attraction.feature_names_by_id|jsonize }};
    var locations = {{ attraction.locations_by_feature_id|jsonize }};
    var allLocations = {{ c.EVENT_LOCATIONS|jsonize }};

    var deleteEvent = function(eventId, callback) {
      callback = callback || function() {}
      $.ajax({
        method: 'POST',
        url: 'delete_event',
        data: {
          id: eventId,
          csrf_token: csrf_token
        },
        success: function(response, status) {
          if (response && response['error']) {
            callback('There was an error deleting the event: ' + response['error']);
          } else {
            callback();
          }
        },
        error: function(response, status, statusText) {
          callback('There was an error updating the room: ' + statusText);
        }
      });
    };

    $('.room-col').on('click', '.btn-danger', function(event) {
      event.preventDefault();
      var $button = $(this);
          eventId = $button.data('eventId'),
          eventLabel = $button.data('eventLabel');

      var callback = function(error) {
        if(error) {
          toastr.error(error);
        } else {
          var $event = $button.closest('.event');
          $event.css({'height': $event.height(), 'min-height': ''});
          $event.animate({'height': 0, 'opacity': 0}, 'fast', function() {
            $(this).remove();
          });
        }
      };

      bootbox.confirm({
        backdrop: true,
        message: '<p>Are you sure you want to delete ' + eventLabel + '?</p>' +
          '<p>This cannot be undone.</p>',
        buttons: {
          confirm: { label: 'Delete Event', className: 'btn-danger' },
          cancel: { label: 'Nevermind', className: 'btn-default' }
        },
        callback: function (result) {
          if (result) {
            deleteEvent(eventId, callback);
          }
        }
      });
    });

    var updateLocations = function(featureId, oldValue, newValue, callback) {
      callback = callback || function() {}
      $.ajax({
        method: 'POST',
        url: 'update_locations',
        data: {
          feature_id: featureId,
          old_location: oldValue,
          new_location: newValue,
          csrf_token: csrf_token
        },
        success: function(response, status) {
          if (response && response['error']) {
            callback('There was an error updating the room: ' + response['error']);
          } else {
            callback();
          }
        },
        error: function(response, status, statusText) {
          callback('There was an error updating the room: ' + statusText);
        }
      });
    };

    $('.room-title > select').on('change', function(event) {
      var $select = $(this);
      try {
        var featureId = $select.data('featureId'),
            oldValue = parseInt($select.data('initialValue')),
            newValue = parseInt($select.val());

        if(featureId && oldValue && newValue && newValue != oldValue) {
          if(locations[featureId][newValue]) {
            bootbox.confirm({
              backdrop: true,
              message: '<p>Are you sure you want to move the <b>' + features[featureId] + '</b> events?</p>' +
                '<p>'+
                  '<label style="width: 64px; text-align: right;">From</label> ' + locations[featureId][oldValue] + '<br>' +
                  '<label style="width: 64px; text-align: right;">To</label> ' + locations[featureId][newValue] +
                '</p>' +
                '<p>This could cause scheduling conflicts.</p>',
              buttons: {
                confirm: { label: 'Merge Rooms', className: 'btn-danger' },
                cancel: { label: 'Nevermind', className: 'btn-default' }
              },
              callback: function(result) {
                if (result) {
                  updateLocations(featureId, oldValue, newValue, function(error) {
                    if(error) {
                      toastr.error(error);
                      $select.val(oldValue);
                    } else {
                      window.location = window.location + '&message=Successfully merged rooms!';
                    }
                  });
                } else {
                  $select.val(oldValue);
                }
              }
            });
          } else {
            updateLocations(featureId, oldValue, newValue, function(error) {
              if(error) {
                toastr.error(error);
                $select.val(oldValue);
              } else {
                $select.data('initialValue', newValue);
                delete locations[featureId][oldValue];
                locations[featureId][newValue] = allLocations[newValue];
              }
            });
          }
        }
      } catch(ex) {
        $select.val($select.data('initialValue'));
        console.log(ex);
      }
    });
  });
</script>

{%- set can_admin_attraction = admin_account.attendee.can_admin_attraction(attraction) -%}
<div
    id="edit_attraction"
    class="modal fade"
    tabindex="-1"
    role="dialog"
    aria-labelledby="edit_attraction_title"
    style="display: none">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="edit_attraction_title">
          <span class="glyphicon glyphicon-cog"></span>
          Edit {{ attraction.name }}
        </h4>
      </div>
      <form method="post" action="form" class="form-horizontal" role="form">
        <div class="modal-body">
          {{ attraction_macros.attraction_form(attraction) }}
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<h1>
  {% if can_admin_attraction -%}
    <form
        method="post"
        action="delete"
        class="pull-right"
        role="form"
        onsubmit="return confirm('Are you sure you want to delete this attraction?');"
        {% if attraction.features %}title="You cannot delete an attraction that has any features"{% endif %}>
      {{ csrf_token() }}
      <input type="hidden" name="id" value="{{ attraction.id }}">
      <button
          type="submit"
          class="btn btn-xs btn-danger"
          {% if attraction.features %}disabled="disabled"{% endif %}>
        <span class="glyphicon glyphicon-remove"></span>
        Delete Attraction
      </button>
    </form>
  {%- endif %}
  {{ attraction.name }} Attraction
  {% if can_admin_attraction -%}
    <button
        type="button"
        class="btn btn-xs btn-primary"
        data-toggle="modal"
        data-target="#edit_attraction"
        title="Edit the {{ attraction.name }} Attraction">
      <span class="glyphicon glyphicon-cog"></span>
    </button>
  {%- endif %}
</h1>

<div class="attraction-info info-block">
  <p>{{ attraction.description|linebreaksbr }}</p>

  {% if attraction.restriction != attraction.NONE -%}
    <p>{{ attraction.RESTRICTIONS[attraction.restriction].split('–')|last|trim }}.</p>
  {%- endif %}

  {% if attraction.notifications %}
    {% if attraction.notifications|length == 1 %}
      <p>Attendees will be notified about {{ attraction.name }} events
      {{ humanize_timedelta(seconds=attraction.notifications|first, now='when the event starts', suffix=' before') }}.</p>
    {% else %}
      Attendees will be notified about {{ attraction.name }} events:
      <ul>
        {% for notification in attraction.notifications %}
          <li>{{ humanize_timedelta(seconds=notification, now='when the event starts', suffix=' before') }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% else %}
    <p>Attendees will <b>NOT</b> be notified before the start of an {{ attraction.name }} event.</p>
  {% endif %}
  {% if attraction.department_id -%}
    <p class="help-block">
      <em>The {{ attraction.name }} attraction belongs to the {{ attraction.department|form_link }} department.</em>
    </p>
  {%- endif %}
</div>

<h2>
  {{ attraction.name }} Features
  {% if can_admin_attraction -%}
    <a class="btn btn-xs btn-primary"
        title="Add a new feature"
        href="feature?attraction_id={{ attraction.id }}">
      <span class="glyphicon glyphicon-plus"></span>
      Add Feature
    </a>
  {%- endif %}
</h2>
<p class="help-block feature-help-block">
  <em>Features can be people, activities, performances, or anything else attendees might need to wait in line for.</em>
</p>
{% if attraction.features %}
  {% set used_location_opts = attraction.used_location_opts %}
  {% set unused_location_opts = attraction.unused_location_opts %}
  {% set events_by_feature = attraction.events_by_feature %}
  <div class="row row-stacked feature-container">
    <div class="col-sm-stacked">
      <ul class="nav nav-pills nav-sm-stacked">
        {% if events_by_feature %}
          {% for feature, events_by_location in events_by_feature.items() %}
            <li role="presentation" class="{% if loop.index0 == 0 %}active{% endif %}">
              <a href="#feature_{{ feature.id }}" data-toggle="pill">
                <h3>{{ feature.name }}</h3>
              </a>
            </li>
          {% endfor %}
        {% endif %}
      </ul>
    </div>
    <div class="col-sm-stacked-content">
      <div class="features tab-content">
        {% if events_by_feature %}
          {% for feature, events_by_location in events_by_feature.items() %}
            <div role="tabpanel" class="tab-pane feature {% if loop.index0 == 0 %}active{% endif %}" id="feature_{{ feature.id }}">
              <div class="feature-heading">
                <h3 class="feature-title">
                  {% if can_admin_attraction -%}
                    <div class="controls pull-right">
                      <a class="btn btn-xs btn-primary btn-fade"
                          title="Edit the {{ feature.name }} feature"
                          href="feature?id={{ feature.id }}">
                        <span class="glyphicon glyphicon-cog"></span>
                      </a>
                      <form
                          method="post"
                          action="delete_feature"
                          role="form"
                          onsubmit="return confirm('Are you sure you want to delete this feature? This will also delete any associated events.');"
                          title="Delete the {{ feature.name }} feature">
                        {{ csrf_token() }}
                        <input type="hidden" name="id" value="{{ feature.id }}">
                        <button type="submit" class="btn btn-xs btn-danger btn-fade">
                          <span class="glyphicon glyphicon-remove"></span>
                        </button>
                      </form>
                    </div>
                  {%- endif %}
                  <span>{{ feature.name }}</span>
                  {% if can_admin_attraction -%}
                    <a class="btn btn-xs btn-primary"
                        title="Schedule a new {{ feature.name }} event"
                        href="event?feature_id={{ feature.id }}">
                      <span class="glyphicon glyphicon-time"></span>
                      Schedule Event
                    </a>
                  {%- endif %}
                </h3>
              </div>
              <div class="feature-body">
                <div class="feature-description">{{ feature.description|linebreaksbr }}</div>
                {% if events_by_location %}
                  {% set col_count = [events_by_location|length, 2]|sort|first %}
                  {% set col_width = 12 // (col_count if col_count > 0 else 1) %}
                  {% for location, events in events_by_location.items() %}
                    {% if (loop.index0 % col_count) == 0 %}<div class="row">{% endif %}
                    <div class="col-md-{{ col_width }}">
                      <div class="room-col">
                        <div class="room-title">
                          {% if can_admin_attraction -%}
                            <select class="form-control" data-feature-id="{{ feature.id }}" data-initial-value="{{ location }}">
                              {% if used_location_opts %}
                                {{ options(used_location_opts, location) }}
                                <option disabled="disabled">––––––––––</option>
                              {% endif %}
                              {{ options(unused_location_opts, location) }}
                            </select>
                          {% else %}
                            <h5 class="text-center">{{ format_location(location, separator=' ', spacer=False) }}</h5>
                          {%- endif %}
                        </div>
                        <div class="room-body">
                          {% for event in events %}
                            <div class="event info-block" style="min-height: {{ (event.duration // 90) - 6 }}px">
                              {% if can_admin_attraction -%}
                                <div class="controls pull-right">
                                  <a class="btn btn-xs btn-primary btn-fade"
                                      title="Edit this event"
                                      href="event?id={{ event.id }}">
                                    <span class="glyphicon glyphicon-cog"></span>
                                  </a>
                                  <button type="submit" class="btn btn-xs btn-danger btn-fade" data-event-id="{{ event.id }}" data-event-label="{{ event.label }}">
                                    <span class="glyphicon glyphicon-remove"></span>
                                  </button>
                                </div>
                              {%- endif %}
                              <div class="event-body">
                                <div>{{ event.time_span_label }}</div>
                                <div>{{ event.duration_label }} ({{ event.attendees|length }} / {{ event.slots }} slots taken)</div>
                              </div>
                            </div>
                            {% set overlap = event.overlap(events[loop.index]) %}
                            {% if overlap > 0 %}
                              <div class="event-spacer event-overlap text-center text-danger">
                                {{ humanize_timedelta(seconds=overlap, separator=' ') }} overlap
                              </div>
                            {% elif overlap < 0 %}
                              <div class="event-spacer text-center text-info" style="line-height: {{ [[(overlap // -180) + 6, 16]|sort|last, 100]|sort|first }}px">
                                {{ humanize_timedelta(seconds=overlap, separator=' ') }} available
                              </div>
                            {% endif %}
                          {% endfor %}
                        </div>
                      </div>
                    </div>
                    {% if loop.last or (loop.index0 % col_count) == (col_count - 1) %}</div>{% endif %}
                  {% endfor %}
                {% else %}
                  <hr>
                  <div class="empty-message">
                    No events have been scheduled for the <b>{{ feature.name }}</b> feature yet.
                  </div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        {% endif %}
      </div>
    </div>
  </div>
{% endif %}
{% endblock %}
