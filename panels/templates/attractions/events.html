{% extends "preregistration/preregbase.html" %}
{% block title %}Attractions{% endblock %}
{% import 'attractions/attractions_macros.html' as attractions_macros with context %}

{% block content %}
{% include 'attractions/attractions_common.html' %}
<style type="text/css">
  .hover-btn + .hover-btn {
    margin-top: 0;
  }

  .hover-btn-title h2 {
    font-size: 1.125em;
  }

  .hover-btn-body p {
    margin: 0;
  }

  .filter-bar {
    margin-bottom: 20px;
  }

  .slots {
    font-size: 1.2em;
    vertical-align: middle;
  }

  .modal-body .text-success {
    font-weight: bold;
  }

  #signup_modal .modal-body {
    font-weight: normal;
    padding-left: 2em;
  }

  #signup_done_modal form p {
    margin-bottom: 20px;
  }

  #friend_row .attendee,
  #signup_done_modal .btn .attendee {
    display: inline-block;
  }

  #friend_row .attendee {
    font-size: 1.5em;
  }

  .slide-box {
    position: relative;
    height: 3.125em;
  }

  .slide-box .row {
    position: absolute;
    height: 2.8125em;
    width: 100%;
    top: 0;
    left: 15px;
  }
</style>

<script>
  $(function() {
    var $body = $('body'),
        $signupModal = $('#signup_modal'),
        $signupForm = $('#signup_form'),
        $signupOkButton = $('#signup_ok'),
        $signupEventLabels = $('.signup-event-label'),
        $signupEventLocations = $('.signup-event-location'),
        $btnShowSoldout = $('#btn_show_soldout'),
        $signupDoneModal = $('#signup_done_modal'),
        $badgeNumForm = $('#badge_num_form'),
        $badgeNum = $('#badge_num');

    $btnShowSoldout.on('click', function(event) {
      var isShowing = $btnShowSoldout.hasClass('btn-plain');
      $btnShowSoldout.toggleClass('btn-default', isShowing);
      $btnShowSoldout.toggleClass('btn-plain', !isShowing);
      $body.toggleClass('show-soldout', !isShowing);
    });

    var signupForEvent = function(eventId, badgeNum, callback) {
      $.ajax({
        method: 'POST',
        url: 'signup_for_event',
        data: {
          badge_num: badgeNum,
          id: eventId,
          csrf_token: csrf_token
        },
        success: function(response, status) {
          if (response && response['result']) {
            callback(response);
          } else {
            toastr.error(response['error'] || 'Error signing up for event', '', {timeOut: 3000});
            callback(false);
          }
        },
        error: function(response, status, statusText) {
          toastr.error('Error signing up for event', '', {timeOut: 3000});
          callback(false);
        }
      });
    };

    $signupModal.on('show.bs.modal', function(event) {
      var $openButton = $(event.relatedTarget),
          eventId = $openButton.data('eventId'),
          eventName = $openButton.data('eventName'),
          eventStartTime = $openButton.data('eventStartTime'),
          $eventLocation = $('#' + eventId + ' .event-location');
      $signupOkButton.data('eventId', eventId);
      $signupEventLabels.html('<span class="text-success">' + eventName + '</span> at <span class="text-success">' + eventStartTime + '</span>');
      $signupEventLocations.html($eventLocation.html());
    });

    $signupForm.on('submit', function(event) {
      event.preventDefault();
      var eventId = $signupOkButton.data('eventId'),
          badgeNum = '{{ attendee.badge_num }}';
      signupForEvent(eventId, badgeNum, function(response) {
        if (response) {
          $('#' + eventId).addClass('signedup');
          $signupModal.modal('hide');
          $signupDoneModal.data('remainingSlots', response['remaining_slots']);
          $signupDoneModal.modal('show');
        }
      });
    });

    $signupDoneModal.on('shown.bs.modal', function (event) {
      $('#badge_num').focus();
    });

    var showFriend = function() {
      $('#badge_num_row').hide('slide', {direction: 'left'}, 250);
      $('#friend_row').show('slide', {direction: 'right'}, 250);
      $('#friend_label').fadeOut(125, function() {
        $('#friend_confirm').fadeIn(125);
      });
    };

    var hideFriend = function(clear) {
      $('#friend_confirm').fadeOut(125, function() {
        $('#friend_label').fadeIn(125);
      });
      $('#friend_row').hide('slide', {direction: 'right'}, 250);
      $('#badge_num_row').show('slide', {direction: 'left'}, 250, function() {
        if (clear) {
          $badgeNum.val('');
        }
        $badgeNum.focus();
      });
    };

    $('#friend_row .btn-danger').on('click', function (event) {
      event.preventDefault();
      hideFriend(false);
    });

    $('#friend_row .btn-success').on('click', function (event) {
      event.preventDefault();
      var eventId = $signupOkButton.data('eventId'),
          badgeNum = $badgeNum.val();
      signupForEvent(eventId, badgeNum, function(response) {
        if (response) {
          $signupDoneModal.data('remainingSlots', response['remaining_slots']);
          toastr.info($('#friend_row .attendee').html() + ' signed up!');
          hideFriend(true);
        }
      });
    });

    $badgeNumForm.on('submit', function(event) {
      event.preventDefault();
      badgeNum = $badgeNum.val();
      if (!badgeNum) {
        return;
      }

      if (badgeNum === '{{ attendee.badge_num }}') {
        toastr.warning("Hey, that's you!", '', {timeOut: 3000});
        $badgeNum.focus();
        return;
      }

      $.ajax({
        method: 'POST',
        url: 'is_badge_num_valid',
        data: {
          badge_num: badgeNum,
          csrf_token: csrf_token
        },
        success: function(response, status) {
          if (response && response['first_name'] && response['badge_num']) {
            $('#friend_row .name').text(response['first_name']);
            $('#friend_row .badge-num').text('#' + response['badge_num']);
            showFriend();
          } else {
            toastr.error('Unrecognized badge number: ' + badgeNum, '', {timeOut: 3000});
          }
        },
        error: function(response, status, statusText) {
          toastr.error('Unrecognized badge number: ' + badgeNum, '', {timeOut: 3000});
        }
      });
    });
  });
</script>

<div id="signup_modal"
    class="modal fade"
    tabindex="-1"
    role="dialog"
    aria-labelledby="signup_modal_title"
    style="display: none">
  <div class="modal-dialog modal-md" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title">{{ attractions_macros.greeting(attendee) }}</h4>
      </div>
      <form id="signup_form" method="post" action="signup_for_event" class="form-horizontal" role="form">
        {{ csrf_token() }}
        <div class="modal-body">
          <p>
            Sign up for
            <span class="text-success">{{ feature.attraction.name }} –</span>
            <span class="signup-event-label"></span>?
          </p>
          <p>
            The event will be held in
            <span class="text-success signup-event-location"></span>.
          </p>
          <p>
            You {% if feature.attraction.required_checkin < 0 %}may{% else %}must{% endif %}
            check in {{ feature.attraction.required_checkin_label }}.
          </p>
        </div>
        <div class="modal-footer">
          <button type="submit" id="signup_ok" class="btn btn-success btn-lg btn-xl">
            <span class="glyphicon glyphicon-ok"></span> Okay
          </button>
          <button id="signup_cancel" class="btn btn-default btn-lg btn-xl" data-dismiss="modal">Nevermind</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="signup_done_modal"
    class="modal fade"
    tabindex="-1"
    role="dialog"
    aria-labelledby="signup_done_modal_title"
    style="display: none">
  <div class="modal-dialog modal-md" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title">{{ attractions_macros.greeting(attendee) }}</h4>
      </div>
      <div class="modal-body form-horizontal">
        <p>
          Congratulations, you're signed up for
          <span class="text-success">{{ feature.attraction.name }} –</span>
          <span class="signup-event-label"></span>!
        </p>
        <p>
          The event will be held in
          <span class="text-success signup-event-location"></span>.
          Please check in {{ feature.attraction.required_checkin_label }}.
        </p>
        <form id="badge_num_form" method="post" action="is_badge_num_valid" role="form">
          <p>
            Want to go as a group? You can sign up some friends below...
          </p>
          {{ csrf_token() }}
          <div class="form-group">
            <label class="col-sm-offset-2 col-sm-8">
              <span id="friend_label">Sign up a friend</span>
              <span id="friend_confirm" style="display: none;">Is this the right person?</span>
              &nbsp;
            </label>
            <div class="col-sm-offset-2 col-sm-8 slide-box">
              <div id="badge_num_row" class="row">
                <div class="col-xs-6" style="padding-right: 7px;">
                  <input class="form-control input-lg text-center"
                      type="number"
                      id="badge_num"
                      name="badge_num"
                      placeholder="Badge #"
                      required="required"
                      min="1">
                </div>
                <div class="col-xs-6" style="padding-left: 8px;">
                  <button class="btn btn-lg btn-success" style="width: 100%">
                    <span class="glyphicon glyphicon-ok"></span>
                    Sign up
                  </button>
                </div>
              </div>
              <div id="friend_row" class="row" style="display: none;">
                <div class="col-xs-12">
                  <div class="attendee form-control-static">
                    <span class="name"></span>
                    <sup class="badge-num"></sup>
                  </div>
                  <div class="controls pull-right">
                    <button class="btn btn-lg btn-danger">
                      <span class="glyphicon glyphicon-remove"></span>
                    </button>
                    <button class="btn btn-lg btn-success">
                      <span class="glyphicon glyphicon-ok"></span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="form-group text-center"><b>OR</b></div>
        </form>
        <div class="form-group">
          <div class="col-sm-offset-2 col-sm-8">
            <button class="btn btn-lg btn-xl btn-default" data-dismiss="modal" style="width: 100%">
              Keep browsing{{ attractions_macros.attendee_name(attendee, ' as ') }}
            </button>
          </div>
        </div>
        <div class="form-group">
          <div class="col-sm-offset-2 col-sm-8">
            <a class="btn btn-lg btn-xl btn-primary" style="width: 100%" href="index">
              <span class="glyphicon glyphicon-off"></span>
              All done, log me out!
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="masthead"></div>
<div class="panel panel-default">
  <div class="panel-body">
    {% block body %}
      <a class="btn btn-success btn-back" href="features?id={{ feature.attraction.id }}{% if attendee %}&badge_num={{ attendee.badge_num }}{%endif%}">
        <span class="glyphicon glyphicon-chevron-left"></span>
        <span class="hidden-xs">{{ feature.attraction.name }}</span>
        <span class="visible-xs-inline">Back</span>
      </a>
      {{ attractions_macros.greeting(attendee) }}

      <h1 class="text-center">Schedule for {{ feature.name }}</h1>
      <p class="text-center">
        {{ feature.description|linebreaksbr }}
      </p>
      <hr>
      <div class="filter-bar">
        <button id="btn_show_soldout" class="btn btn-default btn-xs">
          <span class="glyphicon glyphicon-filter"></span>
          Show sold out
        </button>
      </div>
      {%- set is_multi_day = feature.available_events_by_day|length > 1 -%}
      {% for day, events in feature.available_events_by_day.items() %}
        {% if not loop.first %}<hr>{% endif %}
        {% if is_multi_day %}
          <div class="pull-right">
            {% for jump_day in feature.available_events_by_day.keys() %}
              {% if jump_day == day %}
                {{ jump_day[:3] }}
              {% else %}
                <a href="#{{ jump_day }}">{{ jump_day[:3] }}</a>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
        <h2 id="{{ day }}">{{ day }}</h2>
        {% for event in events %}
          {%- set is_signed_up = event in attendee.attraction_events -%}
          {%- set is_sold_out = event.is_sold_out -%}
          <a class="event hover-btn {% if event.is_sold_out %} soldout{% endif%} {% if is_signed_up %} signedup{% endif %}"
              id="{{ event.id }}"
            {% if is_sold_out %}
              disabled="disabled"
            {% elif is_signed_up %}
              href="#"
              data-toggle="modal"
              data-target="#signup_done_modal"
            {% else %}
              href="#"
              data-toggle="modal"
              data-target="#signup_modal"
            {%- endif %}
              data-event-id="{{ event.id }}"
              data-event-name="{{ event.name }}"
              data-event-location="{{ event.location }}"
              data-event-start-time="{{ event.start_time_label }}">
            <div class="hover-btn-title">
              <button class="btn btn-success btn-next btn-next-sm pull-right"
                  {% if is_sold_out %}disabled="disabled"{% endif %}>
                <span class="glyphicon glyphicon-ok"></span>
              </button>
              <h2><span class="bling-icon"></span> {{ event.time_span_label }}</h2>
              <em class="text-nowrap">{{ event.duration_label }}</em>
            </div>
            <div class="hover-btn-body">
              <p class="event-location">{{ format_location(event.location, separator=' ', spacer='', text_class='') }}</p>
              <p>
                {% if is_sold_out %}
                  <span class="text-danger">
                    <b class="slots">SOLD OUT</b> all <em class="slots">{{ event.slots }}</em> slot{{ event.remaining_slots|pluralize }} taken
                  </span>
                {% else %}
                  <em class="slots">{{ event.remaining_slots }}</em> out of
                  <em class="slots">{{ event.slots }}</em> slot{{ event.remaining_slots|pluralize }} available
                {% endif %}
              </p>
              <p class="show-signedup"><em class="text-success">You are signed up for this event!</em></p>
            </div>
          </a>
        {% endfor %}
      {% endfor %}
    {% endblock %}
  </div>
</div>
{% endblock %}
